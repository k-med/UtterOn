{{ define "main" }}
{{ $groups := .GetPage "groups" }}
{{ $groupsData := slice }}
{{ range $groups.Pages.ByWeight }}
{{ $groupsData = $groupsData | append .Params }}
{{ end }}
<div class="utteron-container" id="app-container" data-groups="{{ $groupsData | jsonify }}">
    <div class="language-header-card">
        <div class="lang-title-section">
            <h1>{{ .Title }}</h1>
            <div class="native-name-row">
                <span class="native-name-large">{{ .Params.native_name }}</span>
                <button class="audio-btn" onclick="playNativeName('{{ .File.ContentBaseName }}')"
                    aria-label="Play pronunciation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
            </div>
            <div class="lang-flag-display">{{ .Params.flag }}</div>
        </div>

        <div class="lang-stats-grid">
            <div class="stat-col">
                <span class="stat-label-sm">Streak</span>
                <span class="stat-value-sm" id="stat-streak">0 Days</span>
            </div>
            <div class="stat-col stat-adjustable" data-stat="today">
                <span class="stat-label-sm">Modules Today</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-today">0/5</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col stat-adjustable" data-stat="week">
                <span class="stat-label-sm">Modules (7d)</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-week">0/35</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col stat-adjustable" data-stat="month">
                <span class="stat-label-sm">Modules (30d)</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-month">0/140</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col stat-adjustable" data-stat="year">
                <span class="stat-label-sm">Modules (365d)</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-year">0/1680</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col">
                <span class="stat-label-sm">All</span>
                <span class="stat-value-sm" id="stat-all">0</span>
            </div>
        </div>


    </div>

    <!-- Fundamentals Buttons Row -->
    <div class="fundamentals-section" id="foundations-section"
        onclick="if(event.target.closest('a, button')) return; toggleFoundations()">
        <div class="fundamentals-header">
            <div class="fundamentals-title-group">
                <h2 class="fundamentals-title">Foundations</h2>
                <p class="fundamentals-description">Core vocabulary used throughout the language.</p>
                <p class="fundamentals-explainer">Each item is practiced twice using two exercise modes.</p>
            </div>
            <button type="button" class="minimize-btn" id="minimize-foundations" aria-label="Minimize Foundations">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
        </div>
        <div class="fundamentals-row">
            {{ $lang := .Params.language_code | default .File.ContentBaseName }}
            {{ $groups := .GetPage "groups" }}
            {{ $fundamentalIds := slice "manners" "numbers" "weekdays" "months" "places" "time" }}
            {{ range $fundamentalIds }}
            {{ $groupId := . }}
            {{ range $groups.Pages }}
            {{ if eq .Params.group_id $groupId }}
            {{ $sentenceCount := len .Params.sentences }}
            {{ $estSeconds := mul $sentenceCount 8 }}
            {{ $timeDisplay := "" }}
            {{ if lt $estSeconds 90 }}
            {{ $timeDisplay = "~1 min" }}
            {{ else if lt $estSeconds 150 }}
            {{ $timeDisplay = "~1-2 min" }}
            {{ else }}
            {{ $estMinutes := div $estSeconds 60 }}
            {{ $timeDisplay = printf "~%d min" $estMinutes }}
            {{ end }}
            <a href="{{ $.Permalink }}train/?group={{ $groupId }}" class="fundamental-btn"
                data-group-id="{{ $groupId }}" data-sentence-count="{{ $sentenceCount }}"
                data-time-display="{{ $timeDisplay }}">
                <div class="fundamental-main">
                    <span class="fundamental-label">{{ .Params.group_title }}</span>
                    <span class="fundamental-time">{{ $timeDisplay }}</span>
                </div>
                <div class="fundamental-footer">
                    <span class="fundamental-item-count">{{ $sentenceCount }}</span>
                    <span class="fundamental-score">0/{{ mul $sentenceCount 2 }}</span>
                </div>
            </a>
            {{ end }}
            {{ end }}
            {{ end }}
        </div>
    </div>

    <!-- Modules Header with Master Toggle -->
    <div class="modules-header" onclick="toggleAllCards()">
        <div class="modules-title-group">
            <h2 class="modules-title">Modules</h2>
            <p class="modules-description">Full sentence practice exercises.</p>
        </div>
        <div class="modules-controls">
            <button type="button" class="modules-reset-btn" id="modules-reset"
                onclick="event.stopPropagation(); resetModulesOrder();" aria-label="Reset to default order"
                title="Reset to default order">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
                </svg>
            </button>
            <button type="button" class="modules-toggle-btn" id="modules-toggle" aria-label="Toggle all modules">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
        </div>
    </div>

    <div class="group-list" id="group-list" data-language="{{ .Params.language_code | default .File.ContentBaseName }}">
        {{ $lang := .Params.language_code | default .File.ContentBaseName }}
        {{ $groups := .GetPage "groups" }}
        {{ if $groups }}

        {{/* Build a map of group_id -> list of levels with their params */}}
        {{ $groupMap := dict }}
        {{ range $groups.Pages.ByWeight }}
        {{ if not .Params.fundamental }}
        {{ $gid := .Params.group_id }}
        {{ $lvl := .Params.level | default "A1" }}
        {{/* Store params explicitly so they JSONify correctly */}}
        {{ $levelData := dict "Params" .Params }}
        {{ $existing := index $groupMap $gid }}
        {{ if $existing }}
        {{/* Prefer A1 as basePage, otherwise keep first occurrence */}}
        {{ if eq $lvl "A1" }}
        {{ $groupMap = merge $groupMap (dict $gid (merge $existing (dict $lvl $levelData "basePage" .))) }}
        {{ else }}
        {{ $groupMap = merge $groupMap (dict $gid (merge $existing (dict $lvl $levelData))) }}
        {{ end }}
        {{ else }}
        {{/* First occurrence - set basePage */}}
        {{ $groupMap = merge $groupMap (dict $gid (dict $lvl $levelData "basePage" .)) }}
        {{ end }}
        {{ end }}
        {{ end }}

        {{/* Build sorted list of group IDs by weight */}}
        {{ $sortedGroupIds := slice }}
        {{ range $groups.Pages.ByWeight }}
        {{ if not .Params.fundamental }}
        {{ $gid := .Params.group_id }}
        {{/* Only add if not already in list (handles multiple levels per group) */}}
        {{ if not (in $sortedGroupIds $gid) }}
        {{ $sortedGroupIds = $sortedGroupIds | append $gid }}
        {{ end }}
        {{ end }}
        {{ end }}

        {{/* Render one card per unique group_id in weight order */}}
        {{ range $sortedGroupIds }}
        {{ $groupId := . }}
        {{ $levels := index $groupMap $groupId }}
        {{/* Get the actual page object from basePage key */}}
        {{ $basePage := index $levels "basePage" }}
        {{ with $basePage }}
        {{ $sentenceCount := len .Params.sentences }}
        {{ $baseSeconds := mul $sentenceCount 25 }}
        {{ $level := .Params.level | default "A1" }}
        {{ $multiplier := 100 }}
        {{ if eq $level "A1" }}{{ $multiplier = 100 }}{{ end }}
        {{ if eq $level "A2" }}{{ $multiplier = 115 }}{{ end }}
        {{ if eq $level "B1" }}{{ $multiplier = 135 }}{{ end }}
        {{ if eq $level "B2" }}{{ $multiplier = 160 }}{{ end }}
        {{ if eq $level "C1" }}{{ $multiplier = 190 }}{{ end }}
        {{ if eq $level "C2" }}{{ $multiplier = 220 }}{{ end }}
        {{ $estSeconds := div (mul $baseSeconds $multiplier) 100 }}
        {{ $estMinutes := div $estSeconds 60 }}
        {{ $minLow := $estMinutes }}
        {{ $minHigh := add $estMinutes 2 }}
        {{/* Collect available levels (exclude basePage key) */}}
        {{ $availLevels := slice }}
        {{ range $lvl, $pg := $levels }}{{ if and (ne $lvl "basePage") }}{{ $availLevels = $availLevels | append $lvl
        }}{{ end }}{{ end }}
        {{ $availLevelsStr := delimit (sort $availLevels) "," }}
        <div class="group-card" data-group-id="{{ .Params.group_id }}" data-sentence-count="{{ $sentenceCount }}"
            data-sentences='{{ .Params.sentences | jsonify }}' data-available-levels="{{ $availLevelsStr }}"
            data-levels-data='{{ $levels | jsonify }}'
            onclick="if(event.target.closest('a, button, .clickable, .level-selector, .difficulty-badge-container')) return; toggleGroupCard('{{ .Params.group_id }}')">

            <!-- Card Header (visible only when collapsed) - click to expand -->
            <div class="group-card-header-collapsed">

                <!-- Level selector with chevrons -->
                <div class="level-selector" data-group-id="{{ .Params.group_id }}"
                    data-default-level="{{ .Params.level }}">
                    <button type="button" class="level-chevron level-down"
                        onclick="event.stopPropagation(); switchModuleLevel('{{ .Params.group_id }}', -1)"
                        aria-label="Decrease level">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <span class="level-badge" data-level="{{ .Params.level }}">{{ .Params.level }}</span>
                    <button type="button" class="level-chevron level-up"
                        onclick="event.stopPropagation(); switchModuleLevel('{{ .Params.group_id }}', 1)"
                        aria-label="Increase level">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>

                <div class="group-card-title-group">
                    <h3 class="group-card-title">{{ .Params.group_title }}</h3>
                    {{ with .Params.alt_title }}
                    <span class="group-card-subtitle">{{ . }}</span>
                    {{ end }}
                </div>

                <span class="group-card-time" data-group-id="{{ .Params.group_id }}">~{{ if gt $minLow 0 }}{{ $minLow
                    }}-{{ $minHigh }}{{ else }}1-2{{ end }} min</span>

                <a href="{{ $.Permalink }}train/?group={{ .Params.group_id }}" class="start-btn-compact">Start</a>

                <button type="button" class="group-card-chevron"
                    onclick="event.stopPropagation(); toggleGroupCard('{{ .Params.group_id }}')"
                    aria-label="Toggle card">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                </button>
            </div>

            <div class="group-content-wrapper">
                <div class="group-info-col">
                    {{ $groupId := .Params.group_id }}
                    {{ with .Params.level }}
                    <div class="difficulty-badge-container" data-group-id="{{ $groupId }}">
                        <button class="difficulty-arrow difficulty-arrow-left"
                            onclick="event.stopPropagation(); switchModuleLevel('{{ $groupId }}', -1)"
                            aria-label="Decrease difficulty">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <div class="difficulty-badge" data-level="{{ . }}" onclick="toggleGroupCard('{{ $groupId }}')">
                            <span class="difficulty-category">
                                {{- if or (eq . "A1") (eq . "A2") -}}
                                Beginner
                                {{- else if or (eq . "B1") (eq . "B2") -}}
                                Intermediate
                                {{- else -}}
                                Advanced
                                {{- end -}}
                            </span>
                            <span class="difficulty-level">{{ . }}</span>
                        </div>
                        <button class="difficulty-arrow difficulty-arrow-right"
                            onclick="event.stopPropagation(); switchModuleLevel('{{ $groupId }}', 1)"
                            aria-label="Increase difficulty">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                    {{ end }}

                    <div class="group-header">
                        <h3>{{ if hasPrefix .Params.group_title "The " }}{{ replace .Params.group_title "The " "The<br>"
                            1 | safeHTML }}{{ else }}{{ .Params.group_title }}{{ end }}</h3>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Sentences</div>
                            <div class="stat-value">{{ $sentenceCount }}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Time</div>
                            <div class="stat-value">~{{ if gt $minLow 0 }}{{ $minLow }}-{{ $minHigh }}{{ else }}1-2{{
                                end }} min
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Streak</div>
                            <div class="stat-value group-streak" data-group="{{ .Params.group_id }}">—</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Progress</div>
                            <div class="stat-value last-score" data-group="{{ .Params.group_id }}">—</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Last practiced</div>
                            <div class="stat-value last-practiced" data-group="{{ .Params.group_id }}">Never</div>
                        </div>
                    </div>

                    <a href="{{ $.Permalink }}train/?group={{ .Params.group_id }}" class="start-btn">Start</a>
                </div>

                <div class="group-desc-col">
                    {{ $description := .Params.description }}
                    {{ $lines := split $description "\n" }}
                    {{ $secondaryTitle := index $lines 0 }}
                    {{ $descText := index $lines 1 }}

                    <div class="description-content">
                        {{ if $secondaryTitle }}
                        <h4 class="secondary-title">{{ $secondaryTitle }}</h4>
                        {{ end }}

                        {{ if $descText }}
                        <p class="description-text">{{ $descText }}</p>
                        {{ end }}

                        {{ $sentences := .Params.sentences }}
                        {{ if $sentences }}
                        <div class="sentence-previews">
                            {{ range first 3 (shuffle $sentences) }}
                            <div class="sentence-preview">
                                <span class="preview-native">{{ .native }}</span>
                                <span class="preview-english">{{ .english }}</span>
                            </div>
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>

            <!-- Chevron for expanded view (top-right) -->
            <button type="button" class="group-card-chevron-expanded"
                onclick="event.stopPropagation(); toggleGroupCard('{{ .Params.group_id }}')" aria-label="Collapse card">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
        </div>
        {{ end }}{{/* end with $basePage */}}
        {{ end }}{{/* end range $groupId, $levels */}}
        {{ else }}
        <p>No sentence groups available yet.</p>
        {{ end }}
    </div>
</div>

<script src="/js/utteron.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const lang = document.getElementById('group-list').dataset.language;
        updateGroupCards(lang);
        updateFundamentalsButtons(lang);
        initStatArrows();
        if (window.initFoundationsState) {
            initFoundationsState();
        }
        if (window.initGroupCardState) {
            initGroupCardState();
        }
        if (window.initModuleLevels) {
            initModuleLevels();
        }
    });
</script>
{{ end }}