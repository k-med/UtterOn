{{ define "main" }}
{{ $groups := .GetPage "groups" }}
{{ $groupsData := slice }}
{{ range $groups.Pages }}
{{ $groupsData = $groupsData | append .Params }}
{{ end }}
<div class="utteron-container" id="app-container" data-groups="{{ $groupsData | jsonify }}">
    <div class="language-header-card">
        <div class="lang-title-section">
            <h1>{{ .Title }}</h1>
            <div class="native-name-row">
                <span class="native-name-large">{{ .Params.native_name }}</span>
                <button class="audio-btn" onclick="playNativeName('{{ .File.ContentBaseName }}')"
                    aria-label="Play pronunciation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
            </div>
            <div class="lang-flag-display">{{ .Params.flag }}</div>
        </div>

        <div class="lang-stats-grid">
            <div class="stat-col">
                <span class="stat-label-sm">Streak</span>
                <span class="stat-value-sm" id="stat-streak">0 Days</span>
            </div>
            <div class="stat-col stat-adjustable" data-stat="today">
                <span class="stat-label-sm">Today</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-today">0/5</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col stat-adjustable" data-stat="week">
                <span class="stat-label-sm">Week</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-week">0/35</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col stat-adjustable" data-stat="month">
                <span class="stat-label-sm">Month</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-month">0/140</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col stat-adjustable" data-stat="year">
                <span class="stat-label-sm">Year</span>
                <div class="stat-value-wrapper">
                    <button class="stat-arrow up" aria-label="Decrease"></button>
                    <span class="stat-value-sm" id="stat-year">0/1680</span>
                    <button class="stat-arrow down" aria-label="Increase"></button>
                </div>
            </div>
            <div class="stat-col">
                <span class="stat-label-sm">All</span>
                <span class="stat-value-sm" id="stat-all">0</span>
            </div>
        </div>

        <!-- Fundamentals Buttons Row -->
        <div class="fundamentals-section">
            <span class="fundamentals-caption">Quick vocabulary boosters <span class="reset-note"></span>(Reset
                daily.)</span></span>
            <div class="fundamentals-row">
                {{ $lang := .Params.language_code | default .File.ContentBaseName }}
                {{ $groups := .GetPage "groups" }}
                {{ $fundamentalIds := slice "manners" "numbers" "weekdays" "months" "places" "time" }}
                {{ range $fundamentalIds }}
                {{ $groupId := . }}
                {{ range $groups.Pages }}
                {{ if eq .Params.group_id $groupId }}
                {{ $sentenceCount := len .Params.sentences }}
                {{ $estSeconds := mul $sentenceCount 10 }}
                {{ $timeDisplay := "" }}
                {{ if lt $estSeconds 60 }}
                {{ $timeDisplay = printf "~%ds" $estSeconds }}
                {{ else }}
                {{ $estMinutes := div $estSeconds 60 }}
                {{ $timeDisplay = printf "~%dm" $estMinutes }}
                {{ end }}
                <a href="{{ $.Permalink }}train/?group={{ $groupId }}" class="fundamental-btn"
                    data-group-id="{{ $groupId }}" data-sentence-count="{{ $sentenceCount }}"
                    data-time-display="{{ $timeDisplay }}">
                    <div class="fundamental-main">
                        <span class="fundamental-label">{{ .Params.group_title }}</span>
                        <span class="fundamental-time">{{ $timeDisplay }}</span>
                    </div>
                    <div class="fundamental-footer">
                        <span class="fundamental-item-count">{{ $sentenceCount }}</span>
                        <span class="fundamental-score">0/{{ mul $sentenceCount 2 }}</span>
                    </div>
                </a>
                {{ end }}
                {{ end }}
                {{ end }}
            </div>
        </div>
    </div>

    <div class="group-list" id="group-list" data-language="{{ .Params.language_code | default .File.ContentBaseName }}">
        {{ $lang := .Params.language_code | default .File.ContentBaseName }}
        {{ $groups := .GetPage "groups" }}
        {{ if $groups }}
        {{ range $groups.Pages }}
        {{ if not .Params.fundamental }}
        {{ $sentenceCount := len .Params.sentences }}
        {{ $estMinutes := div (mul $sentenceCount 50) 60 }}
        <div class="group-card" data-group-id="{{ .Params.group_id }}" data-sentence-count="{{ $sentenceCount }}"
            data-sentences='{{ .Params.sentences | jsonify }}'>

            <div class="group-content-wrapper">
                <div class="group-info-col">
                    {{ with .Params.level }}
                    <div class="difficulty-badge-container" data-group-id="{{ $.Params.group_id }}">
                        <button class="difficulty-arrow difficulty-arrow-left" aria-label="Decrease difficulty">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <div class="difficulty-badge" data-level="{{ . }}">
                            <span class="difficulty-category">
                                {{- if or (eq . "A1") (eq . "A2") -}}
                                Beginner
                                {{- else if or (eq . "B1") (eq . "B2") -}}
                                Intermediate
                                {{- else -}}
                                Advanced
                                {{- end -}}
                            </span>
                            <span class="difficulty-level">{{ . }}</span>
                        </div>
                        <button class="difficulty-arrow difficulty-arrow-right" aria-label="Increase difficulty">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                    {{ end }}

                    <div class="group-header">
                        <h3>{{ if hasPrefix .Params.group_title "The " }}{{ replace .Params.group_title "The " "The<br>"
                            1 | safeHTML }}{{ else }}{{ .Params.group_title }}{{ end }}</h3>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Sentences</div>
                            <div class="stat-value">{{ $sentenceCount }}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Time</div>
                            <div class="stat-value">~{{ if gt $estMinutes 0 }}{{ $estMinutes }}{{ else }}1{{ end }} min
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Streak</div>
                            <div class="stat-value group-streak" data-group="{{ .Params.group_id }}">—</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Score</div>
                            <div class="stat-value last-score" data-group="{{ .Params.group_id }}">—</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Last practiced</div>
                            <div class="stat-value last-practiced" data-group="{{ .Params.group_id }}">Never</div>
                        </div>
                    </div>

                    <a href="{{ $.Permalink }}train/?group={{ .Params.group_id }}" class="start-btn">Start</a>
                </div>

                <div class="group-desc-col">
                    {{ $description := .Params.description }}
                    {{ $lines := split $description "\n" }}
                    {{ $secondaryTitle := index $lines 0 }}
                    {{ $descText := index $lines 1 }}

                    <div class="description-content">
                        {{ if $secondaryTitle }}
                        <h4 class="secondary-title">{{ $secondaryTitle }}</h4>
                        {{ end }}

                        {{ if $descText }}
                        <p class="description-text">{{ $descText }}</p>
                        {{ end }}

                        {{ $sentences := .Params.sentences }}
                        {{ if $sentences }}
                        <div class="sentence-previews">
                            {{ range first 3 (shuffle $sentences) }}
                            <div class="sentence-preview">
                                <span class="preview-native">{{ .native }}</span>
                                <span class="preview-english">{{ .english }}</span>
                            </div>
                            {{ end }}
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
        {{ end }}
        {{ end }}
        {{ else }}
        <p>No sentence groups available yet.</p>
        {{ end }}
    </div>
</div>

<script src="/js/utteron.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const lang = document.getElementById('group-list').dataset.language;
        updateGroupCards(lang);
        updateFundamentalsButtons(lang);
        initStatArrows();
        initDifficultyControls();
    });
</script>
{{ end }}