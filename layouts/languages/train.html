{{ define "main" }}
{{ $lang := .Params.language }}
{{ $groupsPage := .Parent.GetPage "groups" }}
{{ $groupsData := slice }}
{{ if $groupsPage }}
{{ range $groupsPage.Pages }}
{{ $data := dict "group_id" .Params.group_id "group_title" .Params.group_title "description" .Params.description
"sentences" .Params.sentences "level" (.Params.level | default "A1") }}
{{ $groupsData = $groupsData | append $data }}
{{ end }}
{{ end }}

<div class="utteron-container train-container" id="train-app" data-language="{{ $lang }}"
    data-groups='{{ $groupsData | jsonify }}'>

    <div class="train-header">
        <a href="{{ .Parent.Permalink }}" class="back-link">‚Üê Back</a>
        <h1 id="group-title">Select a Group</h1>
        <p class="group-subtitle" id="group-subtitle"></p>
    </div>

    <!-- Exercise Card -->
    <div class="exercise-card" id="exercise-card" style="display: none;">

        <!-- Header: Progress & Mode -->
        <div class="exercise-header">
            <div class="progress-container">
                <div class="progress-text">
                    <span id="current-index">1</span> / <span id="total-count">1</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
            </div>
            <div class="mode-badge" id="exercise-type"></div>
        </div>

        <!-- Stable Content Area -->
        <div class="exercise-content">
            <!-- Slot 1: Prompt (Always visible) -->
            <div class="content-slot prompt-slot" id="prompt-area"></div>

            <!-- Slot 2: Interaction (Audio/Input) -->
            <div class="content-slot interaction-slot" id="interaction-area">
                <!-- Audio Player -->
                <div class="audio-controls" id="audio-container" style="display: none;">
                    <button class="audio-btn" id="replay-btn" aria-label="Play audio">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <span>Play Audio</span>
                    </button>
                    <audio id="audio-player"></audio>
                </div>
            </div>

            <!-- Slot 3: Answer (Revealed) -->
            <div class="content-slot answer-slot" id="reveal-area"></div>
        </div>

        <!-- Fixed Action Area -->
        <div class="action-footer">
            <!-- Primary Action (Check/Show Answer/Next) -->
            <button class="action-btn primary" id="action-btn">Reveal</button>

            <!-- Self-Grading Buttons (Hidden initially) -->
            <div class="grading-buttons" id="report-buttons" style="display: none;">
                <button class="grade-btn missed" id="missed-btn">
                    <span class="icon">‚úï</span>
                    <span class="label">Missed it</span>
                </button>
                <button class="grade-btn got-it" id="got-it-btn">
                    <span class="icon">‚úì</span>
                    <span class="label">Got it</span>
                </button>
            </div>
        </div>

        <!-- Completion Overlay (Inside card for context) -->
        <div class="completion-overlay" id="completion-message" style="display: none;">
            <div class="completion-content">
                <div class="completion-icon" id="completion-icon">üéâ</div>
                <h2 id="completion-title">Session Complete!</h2>
                <p id="completion-subtitle">Great work!</p>

                <div class="completion-stats">
                    <div class="stat-circle-large">
                        <svg viewBox="0 0 36 36">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle-fill" id="accuracy-progress" stroke-dasharray="0, 100"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="stat-value" id="accuracy-value">0%</div>
                    </div>
                    <div class="stat-details">
                        <div class="stat-row">
                            <span>Correct</span>
                            <span class="val success" id="correct-count">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Missed</span>
                            <span class="val error" id="missed-count">0</span>
                        </div>
                    </div>
                </div>

                <div class="completion-actions">
                    <button class="action-btn primary" id="retry-btn">Try Again</button>
                    <a href="{{ .Parent.Permalink }}" class="action-btn secondary" id="back-to-groups-btn">Back to
                        Groups</a>
                </div>
            </div>
        </div>
    </div>

    <!-- No Group Selected -->
    <div class="no-group" id="no-group">
        <p>No group selected. Please go back and choose a sentence group.</p>
        <a href="{{ .Parent.Permalink }}" class="action-btn">‚Üê Choose Group</a>
    </div>
</div>

<script src="/js/utteron.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        initTrainingInterface();
    });
</script>
{{ end }}