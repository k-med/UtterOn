{{ define "main" }}
{{ $lang := .Params.language }}
{{ $groupsPage := .Parent.GetPage "groups" }}
{{ $groupsData := slice }}
{{ if $groupsPage }}
{{ range $groupsPage.Pages }}
{{ $data := dict "group_id" .Params.group_id "group_title" .Params.group_title "description" .Params.description
"sentences" .Params.sentences "level" (.Params.level | default "A1") }}
{{ $groupsData = $groupsData | append $data }}
{{ end }}
{{ end }}

<div class="utteron-container train-container" id="train-app" data-language="{{ $lang }}"
    data-groups='{{ $groupsData | jsonify }}'>

    <div class="train-header">
        <a href="{{ .Parent.Permalink }}" class="back-link">‚Üê Back</a>
        <h1 id="group-title">Select a Group</h1>
        <p class="group-subtitle" id="group-subtitle"></p>
    </div>

    <!-- Exercise Card -->
    <div class="exercise-card" id="exercise-card" style="display: none;">

        <!-- Header: Progress & Mode -->
        <div class="exercise-header">
            <div class="progress-container">
                <div class="progress-text">
                    <span id="current-index">1</span> / <span id="total-count">1</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>
            </div>
            <div class="mode-badge" id="exercise-type"></div>
        </div>

        <!-- Stable Content Area -->
        <div class="exercise-content">
            <!-- Slot 1: Prompt (Always visible) -->
            <div class="content-slot prompt-slot" id="prompt-area"></div>

            <!-- Slot 2: Interaction (Audio/Input) -->
            <div class="content-slot interaction-slot" id="interaction-area">
                <!-- Audio Player -->
                <div class="audio-controls" id="audio-container" style="display: none;">
                    <button class="audio-btn" id="replay-btn" aria-label="Play audio">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <span>Play Audio</span>
                    </button>
                    <audio id="audio-player"></audio>
                </div>
            </div>

            <!-- Slot 3: Answer (Revealed) -->
            <div class="content-slot answer-slot" id="reveal-area"></div>
        </div>

        <!-- Fixed Action Area -->
        <div class="action-footer">
            <!-- Primary Action (Check/Show Answer/Next) -->
            <button class="action-btn primary" id="action-btn">Reveal</button>

            <!-- Self-Grading Buttons (Hidden initially) -->
            <div class="grading-buttons" id="report-buttons" style="display: none;">
                <button class="grade-btn missed" id="missed-btn">
                    <span class="icon">‚úï</span>
                    <span class="label">Missed it</span>
                </button>
                <button class="grade-btn got-it" id="got-it-btn">
                    <span class="icon">‚úì</span>
                    <span class="label">Got it</span>
                </button>
            </div>
        </div>

        <!-- Completion Overlay (Inside card for context) -->
        <div id="completion-overlay" class="overlay" style="display: none;">
            <div class="completion-card">
                <!-- Icon & Headline -->
                <div class="completion-header">
                    <div class="completion-icon-wrapper">
                        <span id="completion-icon">üèÜ</span>
                    </div>
                    <h2 id="completion-title">Perfect Score!</h2>
                    <p id="completion-subtitle">You've mastered this group!</p>
                </div>

                <!-- Score Block (Ring + Stats) -->
                <div class="completion-score-block">
                    <!-- Circular Progress -->
                    <div class="progress-ring-container">
                        <svg class="progress-ring" width="120" height="120">
                            <circle class="progress-ring-bg" stroke="rgba(255,255,255,0.1)" stroke-width="8"
                                fill="transparent" r="52" cx="60" cy="60" />
                            <circle id="accuracy-ring" class="progress-ring-circle" stroke="var(--accent)"
                                stroke-width="8" fill="transparent" r="52" cx="60" cy="60" />
                        </svg>
                        <div class="progress-ring-text">
                            <span id="completion-accuracy">100%</span>
                        </div>
                    </div>

                    <!-- Compact Stats -->
                    <div class="completion-stats-compact">
                        <div class="stat-row">
                            <span class="stat-label">Correct</span>
                            <span id="correct-count" class="stat-val correct">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Missed</span>
                            <span id="missed-count" class="stat-val missed">0</span>
                        </div>
                        <!-- Hidden total for JS logic, or displayed if desired -->
                        <span id="total-questions" style="display:none">0</span>
                        <!-- Hidden legacy message element to prevent JS errors -->
                        <span id="completion-text" style="display:none"></span>
                        <div id="completion-stats-grid" style="display:none"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="completion-actions">
                    <button id="retry-btn" class="btn btn-primary btn-block" onclick="retryGroup()">
                        Try Again
                    </button>
                    <button id="back-to-groups-btn" class="btn btn-secondary btn-block" onclick="closeCompletion()">
                        Back to Groups
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- No Group Selected -->
    <div class="no-group" id="no-group">
        <p>No group selected. Please go back and choose a sentence group.</p>
        <a href="{{ .Parent.Permalink }}" class="action-btn">‚Üê Choose Group</a>
    </div>
</div>

<script src="/js/utteron.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        initTrainingInterface();
    });
</script>
{{ end }}